#!/usr/bin/env bash
# status function, prints multiple helpful stats

status_All()
{
	prompt_Sudo;error_Sudo
	print_MoneroBashTitle
	print_Version
	echo
	status_System
	[[ $MONERO_VER != "" ]]&& status_Monero
	[[ $P2POOL_VER != "" ]]&& status_P2Pool
	[[ $XMRIG_VER != "" ]]&& status_XMRig
}

status_System()
{
	$bwhite; printf "System: "
	$bgreen; echo "$(uptime -p)"
	echo
}

status_Template()
{
	$bwhite; echo -n "$NAME_PRETTY: " ;$off
	if pgrep $DIRECTORY/$PROCESS -f &>/dev/null ;then
		$bgreen; echo "online" ;$off

		# ps stats
		ps -o "%p | %C | " -o start -o " | %t | %c" -p $(pgrep $DIRECTORY/$PROCESS -f)

		# process specific stats
		EXTRA_STATS
	else
		$bred; echo "offline" ;$off
	fi
}

status_Monero()
{
	define_Monero
	EXTRA_STATS(){ $binMonero/monerod status ;echo;}
	status_Template
}

status_P2Pool()
{
	define_P2Pool
	EXTRA_STATS()
	{
		$iwhite; echo -n "Wallet: "
		$white; echo "$WALLET"

		# SHARES
		$igreen; printf "Shares found: "
		local sharesFound="$(grep "SHARE" $DIRECTORY/p2pool.log | wc -l)"
		local processUnixTime="$(ps -p $(pgrep $DIRECTORY/$PROCESS -f) -o etimes=)"
		local processHours="$(($processUnixTime / 60 / 60))"
		[[ $processHours = 0 ]]&& processHours="1"
		local sharesPerHour="$((sharesFound / $processHours))"
		$bwhite; printf "$sharesFound "
		echo "($sharesPerHour shares / hour)"
		echo
	}
	status_Template
}

status_XMRig()
{
	define_XMRig
	EXTRA_STATS()
	{
		$iwhite; echo -n "Wallet: " ;$off
		grep "\"user\":" "$xmrigConf" | awk '{print $2}' | tr -d '","'
		$iblue; echo -n "Pool: " ;$off
		grep "\"url\":" "$xmrigConf" | awk '{print $2}' | tr -d '","'

		# SHARES + HASHRATE
		$igreen; echo -n "Accepted shares: " ;$off
		if tac "$binXMRig/xmrig-log" | grep -m1 "accepted" &>/dev/null ;then
			tac "$binXMRig/xmrig-log" | grep -m1 "accepted" | sed "s/].*cpu.*a/] a/"
		else
			echo
		fi
		$ired; echo -n "Hashrate: " ;$off
		tac "$binXMRig/xmrig-log" | grep -m1 "speed" | sed "s/].*miner.*speed/] speed/"
		echo
	}
	status_Template
}
